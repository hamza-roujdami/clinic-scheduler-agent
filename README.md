# Clinic Scheduler Agent

> **⚠️ Demo Purpose Only**  
> This is a **proof-of-concept demonstration** showcasing multi-agent architecture with Microsoft Agent Framework and Foundry. It is **not production-ready code** and uses mock data for testing purposes. 

Multi-agent system for **Abu Dhabi Clinic** appointment scheduling using **Microsoft Agent Framework** with **HandoffBuilder** orchestration pattern.

![App UI](docs/app-ui.png)

## Architecture

**HandoffBuilder Pattern** (Single-tier specialist routing):

```
User → Coordinator Agent (triage & route)
              ↓
    ┌─────────┴─────────┐
    ↓                   ↓
RAG Agent          Booking Agent
(1 tool)           (6 tools)
```

**3 Agents:**
- **Coordinator Agent**: Triages requests and routes to specialists using auto-generated handoff tools
- **RAG Agent**: Handles clinic info queries using `get_clinic_info` tool (mocked, will use Azure AI Search)
- **Booking Agent**: Handles appointments using 6 tools (mocked, will use Booking API + Emirates ID MCP servers)

## Setup

### Prerequisites
- Python 3.10+
- Azure CLI (`az login`)
- Azure Foundry with model deployment

### Installation

```bash
# Create virtual environment
python -m venv .venv
source .venv/bin/activate  # Windows: .venv\Scripts\activate

# Install Microsoft Agent Framework from GitHub (includes HandoffBuilder)
pip install git+https://github.com/microsoft/agent-framework.git@main#subdirectory=python/packages/core

# Install other dependencies
pip install -r requirements.txt

# Configure .env file (see .env.example)
cp .env.example .env
# Edit .env with your Azure Foundry endpoint and model name
```

### Run Web UI

```bash
# Start Gradio web interface
python app.py

# Open http://localhost:7860 in browser
```

### Run Tests

```bash
# Test supervisor with HandoffBuilder workflow
python agents/supervisor.py

```

## Demo Prompts

Try these prompts in the web UI to see the routing in action:

### Info Queries (→ Coordinator → RAG Agent)
```
What are your clinic hours?
Do you accept Daman insurance?
Who are your doctors?
What services do you offer?
Where is the clinic located?
```

### Booking Queries (→ Coordinator → Booking Agent)
```
I want to book an appointment
Check availability for Dr. Ahmed
Cancel confirmation code ABC123
Reschedule my appointment
```

### Full Booking Flow Test (Sequential Steps)
Try this to experience the complete 5-step booking workflow:
```
I want to book an appointment with Dr. Ahmed
```

The booking agent will guide you through:
1. **Emirates ID verification** - Provide last 5 digits (e.g., "12345")
2. **Phone verification** - Provide UAE number (e.g., "+971501234567")
3. **Availability check** - Choose date (e.g., "2025-11-26")
4. **Patient details** - Provide name and reason for visit
5. **Confirmation** - Receive appointment confirmation code

### Greetings (→ Coordinator only)
```
Hello
Hi there
Good morning
```

**Coordinator responds directly without handoff**

## Project Structure

```
agents/
  └── supervisor.py          # HandoffBuilder workflow (coordinator + 2 specialists)
tools/
  ├── rag_tools.py          # Mocked get_clinic_info (→ Azure AI Search)
  └── booking_tools.py      # Mocked booking tools (→ MCP servers)
app.py                      # Gradio web UI
.env                        # Azure Foundry config
requirements.txt            # Dependencies
```

## How It Works

**HandoffBuilder Workflow:**

1. **User message** → Coordinator agent receives it
2. **Coordinator decides** → Calls handoff tool (auto-generated by HandoffBuilder):
   - `handoff_to_rag_agent()` for info queries
   - `handoff_to_booking_agent()` for appointments
   - Or responds directly for greetings
3. **Specialist agent** → Receives the conversation context
4. **Specialist uses tools** → Calls custom tools:
   - RAG Agent: `get_clinic_info(query)`
   - Booking Agent: `validate_emirates_id()`, `book_appointment()`, etc.
5. **Tool result** → Specialist uses result to answer user
6. **Workflow terminates** → Returns to user (after 2+ non-user messages)

**Key Pattern:** `chat_client.create_agent(tools=[...])` is required for tools to work in HandoffBuilder workflows.

## Next Steps

- [ ] Replace `tools/rag_tools.py` with **Azure AI Search** integration
- [ ] Replace `tools/booking_tools.py` with **Booking API MCP Server**
- [ ] Add **Emirates ID Verification MCP Server**
- [ ] Add conversation history/threading
- [ ] Build WhatsApp interface
- [ ] Deploy to production

## Technical Notes

**Why HandoffBuilder?**
- Single-tier routing (coordinator → specialists)
- Auto-generates handoff tools (no manual tool definitions needed)
- Clean separation: routing logic vs domain logic
- Termination conditions built-in

**Tool Integration:**
- ✅ Use `chat_client.create_agent(tools=[...])` for specialists
- ❌ Don't use `ChatAgent(tools=[...])` directly - tools won't be called
- Tool calls are logged via `FunctionCallContent` and `FunctionResultContent` in `AgentRunUpdateEvent`

## Resources

- [Microsoft Agent Framework Documentation](https://learn.microsoft.com/en-us/agent-framework/overview/agent-framework-overview)
- [HandoffBuilder Guide](https://learn.microsoft.com/en-us/agent-framework/user-guide/workflows/orchestrations/handoff)
- [Microsoft Agent Framework GitHub](https://github.com/microsoft/agent-framework)
